#Markdown settings
knitr::opts_chunk$set(echo = TRUE)
#Clear Environment
rm(list=ls())
#Load Packages
library(plyr)
library(dplyr)
library(tidyverse)
library(ggalluvial)
library(RColorBrewer)
library(ggtext)
library(stringr)
library(readxl)
library(leaflet)
library(vroom)
library(sf)
library(data.table)
library(htmlwidgets)
library(broom)
library(lubridate)
library(ggtext)
library(purrr)
# Clear the environment
rm(list = ls())
source_path<- "/Users/rdaillak/Documents/Grad School/ORC IAP Seminar/Git/15.S60_2025/2_data_wrangling_in_R/"
# Read in the listings and the prices_modeled dataframes
listings <- read_csv(paste0(source_path,'data/assignment/listings.csv'))
prices_modeled <- read_csv(paste0(source_path,'data/assignment/prices_modeled.csv'))
prices_modeled<- left_join(
prices_modeled %>%
mutate(DoW=wday(date)),
prices_modeled %>%
mutate(DoW=wday(date))%>%
group_by(DoW)%>%
summarize(periodic=mean(.resid)),
by="DoW")%>%
mutate(remainder=price_per - trend - periodic)
prices_modeled%>%head()
View(prices_modeled)
prices_modeled%>%
slice_head(n=3000)%>%
select(c(`listing_id`,`date`, `price_per`, `trend`, `periodic`, `remainder`))
prices_modeled%>%
slice_head(n=3000)%>%
select(c(`listing_id`,`date`, `price_per`, `trend`, `periodic`, `remainder`))%>%
pivot_longer(cols=c(`price_per`, `trend`, `periodic`, `remainder`),
names_to="price_type",
values_to="price")
prices_modeled%>%
slice_head(n=3000)%>%
select(c(`listing_id`,`date`, `price_per`, `trend`, `periodic`, `remainder`))%>%
pivot_longer(cols=c(`price_per`, `trend`, `periodic`, `remainder`),
names_to="price_type",
values_to="price")%>%
ggplot()+
geom_line(aes(x=date,y=price, group=listing_id), alpha=.5)+
facet_wrap(~price_type, nrow=2, labeller=as_labeller(c(
`price_per` = "Price",
`trend` = "Price Trend",
`periodic` = "Periodic Trend",
`remainder` = "Remainder"
)))+
labs(x="",
y="Dollar Value",
caption="__[1]__ From the raw price data we estimate the price trend using LOESS methods. The periodic trend captures the average price residual for each day of the week in our data. The remainder captures the residual price minus this periodic trend.")+
theme_bw()+
theme(text=element_text(family="Times New Roman"),
axis.title = element_text(face="bold"),
strip.text = element_text(face="bold"),
plot.caption = element_textbox_simple(hjust = 0))
?theme
april_prices <- prices_modeled %>%
filter(lubridate::month(date, label=TRUE, abbr=TRUE) == 'Apr') %>%
select(listing_id, date, remainder)
prices_to_cluster <- april_prices %>%
complete(listing_id, date) %>%
group_by(listing_id) %>%
filter(sum(is.na(remainder)) == 0) %>%
ungroup() %>%
pivot_wider(names_from = date,
values_from = remainder)
# Put this in matrix form, removing the listing identifier
prices_matrix <- prices_to_cluster %>%
select(-listing_id) %>%
as.matrix()
set.seed(1234)
my_kmeans <- function(k){
kmeans(prices_matrix, k)
}
cluster_models <- tibble(k = rep(1:10, 10))
cluster_models<- tibble(k=cluster_models$k, kclust=map(cluster_models$k,my_kmeans))
cluster_performance<- cbind(cluster_models%>%select(k, kclust),
map(cluster_models$kclust, function(x) glance(x))%>%rbindlist())
cluster_performance%>%
group_by(k)%>%
summarize(avg_tot_withinss=mean(tot.withinss))%>%
ggplot()+
geom_line(aes(x=k, y=avg_tot_withinss))+
labs(title="**Total Within-Cluster Sum of Squares by Number of Clusters**<br>*Price Remainders in April*",
x="Number of Clusters",
y="Total Within-Cluster Sum of Squares",
caption="__[1]__ From the raw price data we estimate the price trend using LOESS methods. The periodic trend captures the average price residual for each day of the week in our data. The remainder captures the residual price minus this periodic trend.")+
scale_x_continuous(n.breaks=10, minor_breaks = NULL)+
theme_bw()+
theme(text=element_text(family="Times New Roman"),
plot.title = element_markdown(hjust=.5),
axis.title = element_text(face="bold"),
caption.text)
cluster_performance%>%
group_by(k)%>%
summarize(avg_tot_withinss=mean(tot.withinss))%>%
ggplot()+
geom_line(aes(x=k, y=avg_tot_withinss))+
labs(title="**Total Within-Cluster Sum of Squares by Number of Clusters**<br>*Price Remainders in April*",
x="Number of Clusters",
y="Total Within-Cluster Sum of Squares",
caption="__[1]__ From the raw price data we estimate the price trend using LOESS methods. The periodic trend captures the average price residual for each day of the week in our data. The remainder captures the residual price minus this periodic trend.")+
scale_x_continuous(n.breaks=10, minor_breaks = NULL)+
theme_bw()+
theme(text=element_text(family="Times New Roman"),
plot.title = element_markdown(hjust=.5),
axis.title = element_text(face="bold"))
chosen_model <- cluster_models$kclust[cluster_models$k == 2][[1]]
prices_clustered <- prices_to_cluster %>%
mutate(cluster = chosen_model$cluster) %>%
pivot_longer(cols = -c('cluster', 'listing_id'),
names_to = 'date',
values_to = 'price') %>%
mutate(date = as_date(date))
prices_clustered %>%
group_by(date, cluster)%>%
summarize(avg_price=mean(price),
sd=sd(price))%>%
ggplot()+
geom_ribbon(aes(x=date, ymin=avg_price-sd, ymax=avg_price+sd),
color="lightgrey", fill="lightgrey")+
geom_line(aes(x=date, y=avg_price))+
labs(title= "Average Price Remainder Plus or Minus One Standard Deviation",
x="",
y="Average Price",
caption="__[1]__ From the raw price data we estimate the price trend using LOESS methods. Then we calculate a the periodic trend, _i.e._ the average price residual for each day of the week in our data. The remainder captures the residual price minus this periodic trend.<br>__[2]__ Price remainders were clustered using K-means clustering.")+
scale_x_date(breaks = as.Date(c("2017-04-01","2017-04-08", "2017-04-15", "2017-04-22", "2017-04-30")),
date_labels="%b-%d")+
facet_wrap(~cluster, scales="fixed",
labeller=as_labeller(c(`1`="Cluster 1", `2`="Cluster 2")))+
theme_bw()+
theme(text=element_text(family="Times New Roman"),
plot.title = element_text(face="bold",hjust=.5),
axis.title = element_text(face="bold"),
strip.text = element_text(face="bold"),
axis.text.x = element_text(angle=45, vjust=.5),
plot.caption=element_textbox_simple(hjust=0))
cluster_lookup <- prices_clustered %>%
filter(!duplicated(listing_id)) %>%
select(listing_id, cluster)
locations_to_plot <- listings %>%
left_join(cluster_lookup, by = c('id' = 'listing_id')) %>%
filter(!is.na(cluster)) %>%
select(cluster, latitude, longitude)
pal <- colorFactor(c("navy", "orange"), domain = c("1", "2"))
leaflet(data = locations_to_plot)%>%
addProviderTiles(providers$CartoDB.Positron) %>%
addCircles(~longitude, ~latitude, radius = 50, color = ~pal(cluster))
View(prices_to_cluster)
View(cluster_performance)
#Zip code shapefiles
zips<- st_read("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/Visualizations/Data/tl_2020_us_zcta520")
#Census tract shapefiles
file_names<- list.files("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/Visualizations/Data/Census Tract Shapefiles")
tracts<-map(file_names,function(x) st_read(paste0("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/Visualizations/Data/Census Tract Shapefiles/",x), quiet=TRUE))
#Data on transplant centers
transplant_center<- read_csv("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/Visualizations/Data/transplant_codes.csv",col_types = "cc")%>%
mutate(LISTING_CTR_CODE=str_pad(LISTING_CTR_CODE,width=5,side="left",pad="0"))
ctr_info<- vroom("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/data/kidpan_ctr_ids.csv")%>%
select(LISTING_CTR_CODE,LISTING_CTR_ZIP)%>%unique()
#Census data
census_data<-vroom("/Users/rdaillak/Dropbox/TAD/Grad School/Research/MGH Organ Matching/Visualizations/Data/DECENNIALDHC2020/DECENNIALDHC2020.P9-Data.csv")
